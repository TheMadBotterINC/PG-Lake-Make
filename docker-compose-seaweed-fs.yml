services:
  seaweed-master:
    image: chrislusf/seaweedfs:latest
    command: "master -ip=seaweed-master -port=9333"
    ports: ["9333:9333"]
    volumes: [ "seaweed-master:/data" ]

  seaweed-volume:
    image: chrislusf/seaweedfs:latest
    command: "volume -mserver=seaweed-master:9333 -ip=seaweed-volume -port=8080 -dir=/data"
    depends_on: [seaweed-master]
    ports: ["8080:8080"]
    volumes: [ "seaweed-volume:/data" ]

  seaweed-filer:
    image: chrislusf/seaweedfs:latest
    command: "filer -master=seaweed-master:9333 -ip=seaweed-filer"
    depends_on: [seaweed-master, seaweed-volume]
    ports: ["8888:8888"]

  seaweed-s3:
    image: chrislusf/seaweedfs:latest
    command: "s3 -port=8333 -filer=seaweed-filer:8888"
    depends_on: [seaweed-filer]
    ports: ["8333:8333"]

  postgres:
    image: ghcr.io/themadbotterinc/pg_lake-postgres:latest
    container_name: pg_lake-postgres
    user: postgres
    command: /home/postgres/pgsql-18/bin/postgres -D /home/postgres/pgsql-18/data
    environment:
      POSTGRES_PASSWORD: postgres
    ports: ["0.0.0.0:5432:5432"]
    volumes:
      - postgres-data:/home/postgres/pgsql-18/data
    healthcheck:
      test: ["CMD-SHELL", "/home/postgres/pgsql-18/bin/pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 10

  pgduck_server:
    image: ghcr.io/themadbotterinc/pgduck_server:latest
    container_name: pgduck_server
    user: postgres
    command: /home/postgres/pgsql-18/bin/pgduck_server
    environment:
      DUCKDB_INIT_FILE: /duckdb_init/duckdb_init.sql
    volumes:
      - ./duckdb_init_seaweed.sql:/duckdb_init/duckdb_init.sql:ro
    depends_on:
      seaweed-s3:
        condition: service_started
      postgres:
        condition: service_healthy

  setup-postgres:
    image: ghcr.io/themadbotterinc/pg_lake-postgres:latest
    container_name: setup_postgres
    user: root
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - postgres-data:/home/postgres/pgsql-18/data
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Configuring postgres for external connections..."
        # Enable external TCP connections
        if ! grep -q "listen_addresses = '\*'" /home/postgres/pgsql-18/data/postgresql.conf; then
          echo "listen_addresses = '*'" >> /home/postgres/pgsql-18/data/postgresql.conf
        fi
        if ! grep -q "host all all 0.0.0.0/0 trust" /home/postgres/pgsql-18/data/pg_hba.conf; then
          echo "host all all 0.0.0.0/0 trust" >> /home/postgres/pgsql-18/data/pg_hba.conf
        fi
        
        echo "Creating pgsql_tmp directories..."
        cd /home/postgres/pgsql-18/data/base
        for db_dir in *; do
          if [ -d "$db_dir" ]; then
            mkdir -p "$db_dir/pgsql_tmp"
            chmod 2777 "$db_dir/pgsql_tmp"
            chown postgres:postgres "$db_dir/pgsql_tmp"
            echo "  Created /home/postgres/pgsql-18/data/base/$db_dir/pgsql_tmp"
          fi
        done
        
        # Reload postgres configuration
        /home/postgres/pgsql-18/bin/pg_ctl reload -D /home/postgres/pgsql-18/data
        
        echo "âœ… Postgres configured for external access"
    restart: "no"

  create-bucket:
    image: amazon/aws-cli:latest
    container_name: create_bucket
    depends_on: [seaweed-s3]
    environment:
      AWS_ACCESS_KEY_ID: any
      AWS_SECRET_ACCESS_KEY: any
      AWS_EC2_METADATA_DISABLED: "true"
    entrypoint: ["/bin/sh", "-c"]
    command: ["sleep 10 && aws --endpoint-url=http://seaweed-s3:8333 s3 mb s3://opdi --region us-east-1 || exit 0"]
    restart: "no"

  parquet-seed:
    image: python:3.11-slim
    container_name: parquet_seed
    depends_on:
      create-bucket:
        condition: service_completed_successfully
      setup-postgres:
        condition: service_completed_successfully
    volumes:
      - ./duckdb_init_seaweed.sql:/init/duckdb_init.sql:ro
      - ./seed/seed.duckdb.sql:/seed/seed.duckdb.sql:ro
    command: >
      sh -c "pip install -q duckdb &&
      python -c 'import duckdb; conn = duckdb.connect(); 
      conn.execute(open(\"/init/duckdb_init.sql\").read()); 
      conn.execute(open(\"/seed/seed.duckdb.sql\").read())'"
    restart: "no"

volumes:
  seaweed-master:
  seaweed-volume:
  postgres-data:

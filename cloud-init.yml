#cloud-config
package_update: true
packages:
  - curl
  - unzip
  - jq
  - ufw
  - ca-certificates

write_files:
  - path: /etc/docker/daemon.json
    content: |
      { "log-driver": "json-file", "log-opts": { "max-size": "50m", "max-file": "3" } }

  - path: /opt/pg-lake/docker-compose.yml
    content: |
      version: "3.9"
      services:
        postgres:
          image: ghcr.io/snowflake-labs/pg_lake-postgres:latest
          environment:
            POSTGRES_PASSWORD: postgres
          ports:
            - "0.0.0.0:5432:5432"
          volumes:
            - pgdata:/var/lib/postgresql/data
            - ./pg_init:/docker-entrypoint-initdb.d:ro
          healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres"]
            interval: 10s
            timeout: 5s
            retries: 10

        pgduck_server:
          image: ghcr.io/snowflake-labs/pgduck_server:latest
          environment:
            DUCKDB_INIT_FILE: /duckdb_init/duckdb_init.sql
          volumes:
            - ./duckdb_init.sql:/duckdb_init/duckdb_init.sql:ro
          depends_on: [minio]

        minio:
          image: quay.io/minio/minio:latest
          command: server /data --console-address ":9001"
          environment:
            MINIO_ROOT_USER: minioadmin
            MINIO_ROOT_PASSWORD: minioadmin
          ports:
            - "0.0.0.0:9000:9000"
            - "0.0.0.0:9001:9001"
          volumes:
            - minio:/data

        parquet-seed:
          image: duckdb/duckdb:latest
          depends_on: [minio]
          volumes:
            - ./duckdb_init.sql:/init/duckdb_init.sql:ro
            - ./seed.duckdb.sql:/seed/seed.duckdb.sql:ro
          entrypoint: /bin/sh -c "duckdb -init=/init/duckdb_init.sql -batch /dev/null < /seed/seed.duckdb.sql"
          restart: "no"

      volumes:
        pgdata:
        minio:

  - path: /opt/pg-lake/duckdb_init.sql
    content: |
      SET s3_endpoint = 'minio:9000';
      SET s3_url_style = 'path';
      SET s3_use_ssl = false;
      SET s3_region = 'us-east-1';
      SET s3_access_key_id = 'minioadmin';
      SET s3_secret_access_key = 'minioadmin';

  - path: /opt/pg-lake/pg_init/00_pg_lake.sql
    content: |
      CREATE EXTENSION IF NOT EXISTS pg_lake CASCADE;
      CREATE SERVER IF NOT EXISTS pg_lake_srv FOREIGN DATA WRAPPER pg_lake_table;
      CREATE FOREIGN TABLE IF NOT EXISTS mro_events_parquet()
        SERVER pg_lake_srv
        OPTIONS ( path 's3://opdi/flight_list/mro_events.parquet' );

  - path: /opt/pg-lake/seed/seed.duckdb.sql
    content: |
      CREATE OR REPLACE TABLE mro_events AS
      SELECT
        1000 + row_number() OVER () AS event_id,
        ('N' || lpad(cast(100 + (random()*899)::int as varchar), 3, '0')) AS tail_number,
        date '2025-01-01' + (random()*180)::int AS event_date,
        ['A-CHECK','B-CHECK','C-CHECK','UNSCHEDULED','AOG'][(random()*4)::int+1] AS event_type,
        ['ATL','TPA','JFK','DFW','LHR'][(random()*4)::int+1] AS station,
        ['HYDRAULIC_LEAK','BRAKE_WEAR','AVIONICS_FAULT','CORROSION','ENGINE_OIL'][(random()*4)::int+1] AS fault_code,
        round(1 + random()*48, 1) AS downtime_hours,
        round(500 + random()*150000, 2) AS cost_usd
      FROM range(5000);
      COPY (SELECT * FROM mro_events)
      TO 's3://opdi/flight_list/mro_events.parquet' (FORMAT PARQUET);

runcmd:
  - bash -lc 'curl -fsSL https://get.docker.com | sh'
  - bash -lc 'usermod -aG docker root || true'
  - bash -lc 'systemctl enable docker && systemctl start docker'
  - bash -lc 'ufw allow OpenSSH'
  - bash -lc 'ufw allow 5432'
  - bash -lc 'ufw allow 9000'
  - bash -lc 'ufw allow 9001'
  - bash -lc 'ufw --force enable'
  - bash -lc 'cd /opt/pg-lake && docker compose up -d --wait'
